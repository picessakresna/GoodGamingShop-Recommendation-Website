<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Filtering Website | GoodGamingShop</title>

  <!-- custom css link -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style-prefix.css') }}">

  <!-- google font link -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- D3.js script -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="header-main">
      <div class="container">
        <a href="#" class="header-logo">
          <img src="{{ url_for('static', filename='/images/logo/logo.png') }}" alt="GGS logo" width="140" height="36">
        </a>
        <div class="header-user-actions">
          <a href="{{ url_for('reset_selected_ids') }}" class="reset-link">
            <button class="action-btn">
              <ion-icon name="person-outline"></ion-icon>
            </button>
          </a>
          <a href="{{ url_for('daftar_belanja', user_id=user_id) }}" class="action-link">
            <button class="action-btn" id="daftar-belanja-btn">
              <ion-icon name="bag-handle-outline"></ion-icon>
            </button>
          </a>
        </div>
      </div>
    </div>
    <nav class="desktop-navigation-menu">
      <div class="container">
        <ul class="desktop-menu-category-list">
          <li class="menu-category">
            <a href="{{ url_for('home', user_id=user_id) }}" class="menu-title">Home</a>
          </li>
          <li class="menu-category">
            <a href="{{ url_for('all_items', user_id=user_id)}}" class="menu-title">All Items</a>
          </li>
          <li class="menu-category">
            <a href="{{ url_for('recommend_page', user_id=user_id)}}" class="menu-title">Recommended</a>
          </li>
        </ul>
      </div>
    </nav>
    <div class="mobile-bottom-navigation">
      <button class="action-btn" data-mobile-menu-open-btn>
        <ion-icon name="menu-outline"></ion-icon>
      </button>
      <a href="{{ url_for('daftar_belanja', user_id=user_id) }}" class="action-link">
        <button class="action-btn">
          <ion-icon name="bag-handle-outline"></ion-icon>
        </button>
      </a>
      <button class="action-btn">
        <ion-icon name="home-outline"></ion-icon>
      </button>
      <button class="action-btn">
        <ion-icon name="heart-outline"></ion-icon>
      </button>
      <button class="action-btn" data-mobile-menu-open-btn>
        <ion-icon name="grid-outline"></ion-icon>
      </button>
    </div>
    <nav class="mobile-navigation-menu has-scrollbar" data-mobile-menu>
      <div class="menu-top">
        <h2 class="menu-title">Menu</h2>
        <button class="menu-close-btn" data-mobile-menu-close-btn>
          <ion-icon name="close-outline"></ion-icon>
        </button>
      </div>
    </nav>
  </header>


  <main>
    <div class="container">
      {% if kategori_3_count %}
      <h3>Added To Cart Items :</h3>
      {% endif %}
      <div class="product-main">
        <div class="product-grid">
          {% for product in selected_products %}
          <div class="showcase">
            <div class="showcase-banner">
              <img src="{{ url_for('static', filename='images/images/' ~ product.id_produk ~ '/image_' ~ product.id_produk ~ '_0.png') }}" alt="gambar 1" width="300" class="product-img default">
              <img src="{{ url_for('static', filename='images/images/' ~ product.id_produk ~ '/image_' ~ product.id_produk ~ '_0.png') }}" alt="gambar 2" width="300" class="product-img hover">
            </div>
            <div class="showcase-content">
              <a href="#">
                <h3 class="showcase-title">{{ product.nama_produk }}</h3>
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <p><b>Based on your previous purchases</b>, that show in this graph:</p>
      <!-- D3.js Container -->
      <div id="d3-container" style="display: flex; justify-content: center;"></div>

      {% if kategori_3_count %}
      <p>So we use content based to make <b> suggested based category</b>, this graph of <b>category based recommend </b> items:</p>
      <div id="d3-container-2" style="display: flex; justify-content: center;"></div>
      {% endif %}

      <h3>Recommended Items :</h3>
      <div class="product-main">
        <div class="product-grid" id="recommended-items-grid">
          <!-- Recommended items will be dynamically added here -->
        </div>
        <button id="show-more-btn">Show More</button>
      </div>
    </div>
  </main>


  <!-- D3.js Basic Script -->
  <script>
    // Extract categories from Flask-provided data
    const products = {{ products | tojson }};
    const categories = {};

    products.forEach(product => {
      const category = product.kategori_3;
      if (categories[category]) {
        categories[category]++;
      } else {
        categories[category] = 1;
      }
    });

    // Convert categories object to array
    const data = Object.entries(categories).map(([category, count]) => ({
      category: category,
      count: count
    }));

    // Sort data in descending order based on count
    data.sort((a, b) => b.count - a.count);

    // D3.js setup
    const width = 1300;
    const height = 400;
    const margin = { top: 20, right: 30, bottom: 40, left: 200 };

    const svg = d3.select("#d3-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear()
      .domain([0, d3.max(data, d => d.count)])
      .range([0, width - margin.left - margin.right]);

    const y = d3.scaleBand()
      .domain(data.map(d => d.category))
      .range([0, height - margin.top - margin.bottom])
      .padding(0.1);

    // Add bars
    svg.selectAll("rect")
      .data(data)
      .enter()
      .append("rect")
      .attr("x", 0)
      .attr("y", d => y(d.category))
      .attr("width", d => x(d.count))
      .attr("height", y.bandwidth())
      .attr("fill", "teal");

    // Add count labels
    svg.selectAll(".count-label")
      .data(data)
      .enter()
      .append("text")
      .attr("class", "count-label")
      .attr("x", d => x(d.count) + 10)
      .attr("y", d => y(d.category) + y.bandwidth() / 2)
      .attr("dy", "0.35em")
      .style("font-size", "12px")
      .text(d => d.count);

    // Add category labels
    svg.selectAll(".category-label")
      .data(data)
      .enter()
      .append("text")
      .attr("class", "category-label")
      .attr("x", -10)
      .attr("y", d => y(d.category) + y.bandwidth() / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "end")
      .style("font-size", "16px")
      .text(d => d.category);
  </script>

  {% if kategori_3_count %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // D3.js setup for the second graph
      const kategori3Data = {{ kategori_3_count | tojson }};
      const kategori3Array = Object.keys(kategori3Data).map(key => ({ category: key, count: kategori3Data[key] })).sort((a, b) => b.count - a.count);

      const width2 = 1300;
      const height2 = 400;
      const margin2 = { top: 20, right: 30, bottom: 40, left: 200 };

      const svg2 = d3.select("#d3-container-2")
        .append("svg")
        .attr("width", width2)
        .attr("height", height2)
        .append("g")
        .attr("transform", `translate(${margin2.left},${margin2.top})`);

      const x2 = d3.scaleLinear()
        .domain([0, d3.max(kategori3Array, d => d.count)])
        .range([0, width2 - margin2.left - margin2.right]);

      const y2 = d3.scaleBand()
        .domain(kategori3Array.map(d => d.category))
        .range([0, height2 - margin2.top - margin2.bottom])
        .padding(0.1);

      svg2.selectAll("rect")
        .data(kategori3Array)
        .enter()
        .append("rect")
        .attr("x", 0)
        .attr("y", d => y2(d.category))
        .attr("width", d => x2(d.count))
        .attr("height", y2.bandwidth())
        .attr("fill", "steelblue");

      svg2.selectAll(".count-label")
        .data(kategori3Array)
        .enter()
        .append("text")
        .attr("class", "count-label")
        .attr("x", d => x2(d.count) + 10)
        .attr("y", d => y2(d.category) + y2.bandwidth() / 2)
        .attr("dy", "0.35em")
        .style("font-size", "12px")
        .text(d => d.count);

      svg2.selectAll(".category-label")
        .data(kategori3Array)
        .enter()
        .append("text")
        .attr("class", "category-label")
        .attr("x", -10)
        .attr("y", d => y2(d.category) + y2.bandwidth() / 2)
        .attr("dy", "0.35em")
        .attr("text-anchor", "end")
        .style("font-size", "16px")
        .text(d => d.category);
    });
  </script>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
    const recommendations = {{ recommendations | tojson }};
    const recommendedItemsGrid = document.getElementById('recommended-items-grid');

    let numShown = 0;
    const itemsPerLoad = 4;

    // Function to display recommendations
    function displayNextItems(startIndex) {
        for (let i = startIndex; i < Math.min(startIndex + itemsPerLoad, recommendations.length); i++) {
          const recommend = recommendations[i];
          const showcase = document.createElement('div');
          showcase.classList.add('showcase');

          const showcaseBanner = document.createElement('div');
          showcaseBanner.classList.add('showcase-banner');

          const img1 = document.createElement('img');
          img1.src = `/static/images/images/${recommend.id_produk}/image_${recommend.id_produk}_0.png`;
          img1.alt = 'gambar 1';
          img1.width = 300;
          img1.classList.add('product-img', 'default');

          const img2 = document.createElement('img');
          img2.src = `/static/images/images/${recommend.id_produk}/image_${recommend.id_produk}_0.png`;
          img2.alt = 'gambar 2';
          img2.width = 300;
          img2.classList.add('product-img', 'hover');
          
          const scoreBadge = document.createElement('p');
          scoreBadge.classList.add('showcase-badge');
          scoreBadge.textContent = `Score Product: ${recommend.skor}`;

          showcaseBanner.appendChild(img1);
          showcaseBanner.appendChild(img2);
          showcaseBanner.appendChild(scoreBadge);

          const showcaseContent = document.createElement('div');
          showcaseContent.classList.add('showcase-content');

          const titleLink = document.createElement('a');
          titleLink.href = '#';

          const title = document.createElement('h3');
          title.classList.add('showcase-title');
          title.textContent = recommend.nama_produk;

          titleLink.appendChild(title);
          showcaseContent.appendChild(titleLink);

          showcase.appendChild(showcaseBanner);
          showcase.appendChild(showcaseContent);

          recommendedItemsGrid.appendChild(showcase);
        }

        // Check if all items have been shown
        if (startIndex + itemsPerLoad >= recommendations.length) {
        showMoreBtn.style.display = 'none'; // Hide the button if no more items to show
        }
    }

    // Initial display
    displayNextItems(numShown);

    // Show more button functionality
    const showMoreBtn = document.getElementById('show-more-btn');

    showMoreBtn.addEventListener('click', function () {
        numShown += itemsPerLoad;
        displayNextItems(numShown);
    });
    });


  </script>

  <!-- ionicon link -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

</body>

</html>
